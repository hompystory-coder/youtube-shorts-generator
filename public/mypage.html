<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€ - YouTube Shorts Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-button.active {
            background: linear-gradient(to right, #9333ea, #ec4899);
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fas fa-video text-3xl text-blue-600"></i>
                    <h1 class="text-2xl font-bold text-gray-800">YouTube Shorts Generator</h1>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <img src="" alt="Profile" class="w-10 h-10 rounded-full border-2 border-purple-500" id="userAvatar">
                        <div>
                            <p class="font-semibold text-gray-800" id="userName">ë¡œë”©ì¤‘...</p>
                            <p class="text-xs text-gray-500" id="userEmail"></p>
                        </div>
                    </div>
                    <a href="/" class="px-4 py-2 text-gray-700 hover:text-blue-600 transition">
                        <i class="fas fa-home mr-1"></i>í™ˆ
                    </a>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                        <i class="fas fa-sign-out-alt mr-1"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- ìƒë‹¨ í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-4xl font-bold text-blue-600" id="totalVideos">0</div>
                <div class="text-sm text-gray-600 mt-2">ìƒì„±í•œ ì˜ìƒ</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-4xl font-bold text-green-600" id="totalProjects">0</div>
                <div class="text-sm text-gray-600 mt-2">ì´ í”„ë¡œì íŠ¸</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-4xl font-bold text-purple-600" id="memberSince">0ì¼</div>
                <div class="text-sm text-gray-600 mt-2">ê°€ì… ê²½ê³¼</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <span class="inline-block px-4 py-2 text-sm font-bold rounded-full" id="userRoleBadge">ì‚¬ìš©ì</span>
                <div class="text-sm text-gray-600 mt-2">ê³„ì • ë“±ê¸‰</div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="flex border-b border-gray-200">
                <button onclick="switchTab('subscription')" class="tab-button flex-1 py-4 px-6 font-semibold text-gray-600 hover:bg-gray-50 transition active" id="tab-subscription">
                    <i class="fas fa-crown mr-2"></i>êµ¬ë… ì •ë³´
                </button>
                <button onclick="switchTab('payments')" class="tab-button flex-1 py-4 px-6 font-semibold text-gray-600 hover:bg-gray-50 transition" id="tab-payments">
                    <i class="fas fa-receipt mr-2"></i>ê²°ì œ ë‚´ì—­
                </button>
                <button onclick="switchTab('apikeys')" class="tab-button flex-1 py-4 px-6 font-semibold text-gray-600 hover:bg-gray-50 transition" id="tab-apikeys">
                    <i class="fas fa-key mr-2"></i>API í‚¤ ì„¤ì •
                </button>
            </div>

            <!-- íƒ­ ì»¨í…ì¸  -->
            <div class="p-8">
                <!-- êµ¬ë… ì •ë³´ íƒ­ -->
                <div id="content-subscription" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-crown text-yellow-500 mr-2"></i>
                        í˜„ì¬ êµ¬ë… ìƒíƒœ
                    </h2>

                    <!-- ë¡œë”© -->
                    <div id="subscriptionLoading" class="text-center py-16">
                        <i class="fas fa-spinner fa-spin text-5xl text-purple-500 mb-4"></i>
                        <p class="text-gray-600">êµ¬ë… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <!-- êµ¬ë… ì—†ìŒ -->
                    <div id="subscriptionEmpty" class="hidden text-center py-16">
                        <i class="fas fa-times-circle text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">í™œì„±í™”ëœ êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="text-gray-500 mb-6">í”„ë¦¬ë¯¸ì—„ í”Œëœì„ êµ¬ë…í•˜ê³  ë¬´ì œí•œìœ¼ë¡œ ì˜ìƒì„ ìƒì„±í•˜ì„¸ìš”!</p>
                        <a href="/payment" class="inline-block px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition font-bold text-lg shadow-xl">
                            <i class="fas fa-shopping-cart mr-2"></i>ì§€ê¸ˆ êµ¬ë…í•˜ê¸°
                        </a>
                    </div>

                    <!-- êµ¬ë… ì •ë³´ -->
                    <div id="subscriptionInfo" class="hidden"></div>
                </div>

                <!-- ê²°ì œ ë‚´ì—­ íƒ­ -->
                <div id="content-payments" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-receipt text-green-600 mr-2"></i>
                        ê²°ì œ ë‚´ì—­
                    </h2>

                    <!-- ë¡œë”© -->
                    <div id="paymentHistoryLoading" class="text-center py-16">
                        <i class="fas fa-spinner fa-spin text-5xl text-green-500 mb-4"></i>
                        <p class="text-gray-600">ê²°ì œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <!-- ê²°ì œ ì—†ìŒ -->
                    <div id="paymentHistoryEmpty" class="hidden text-center py-16">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="text-gray-500 mb-6">ì²« êµ¬ë…ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                        <a href="/payment" class="inline-block px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition font-bold text-lg shadow-xl">
                            <i class="fas fa-shopping-cart mr-2"></i>êµ¬ë… í”Œëœ ë³´ê¸°
                        </a>
                    </div>

                    <!-- ê²°ì œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ -->
                    <div id="paymentHistoryList" class="hidden space-y-4"></div>
                </div>

                <!-- API í‚¤ ì„¤ì • íƒ­ -->
                <div id="content-apikeys" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-key text-blue-600 mr-2"></i>
                        API í‚¤ ì„¤ì •
                    </h2>

                    <form id="apiKeyForm" class="space-y-6">
                        <!-- Gemini API Key -->
                        <div class="bg-blue-50 rounded-xl p-6 border-2 border-blue-200">
                            <label class="flex items-center gap-2 text-lg font-bold text-gray-800 mb-3">
                                <i class="fas fa-robot text-blue-600 text-2xl"></i>
                                Gemini API Key
                                <span class="text-sm font-normal text-gray-500">(ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ìš©)</span>
                            </label>
                            <div class="relative mb-2">
                                <input type="password" id="geminiApiKey" name="geminiApiKey"
                                    class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-lg"
                                    placeholder="AIzaSy...">
                                <button type="button" onclick="togglePassword('geminiApiKey')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-600">
                                <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-semibold">
                                    <i class="fas fa-external-link-alt mr-1"></i>Google AI Studioì—ì„œ ë°œê¸‰ë°›ê¸°
                                </a>
                            </p>
                        </div>

                        <!-- Gemini Model -->
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-brain text-purple-600"></i>
                                Gemini ëª¨ë¸ ì„ íƒ
                            </label>
                            <select id="geminiModel" name="geminiModel"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (ìµœì‹ , ì¶”ì²œ) â­</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash (ë¹ ë¦„, ì €ë ´)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro (ì •í™•, ë¹„ìŒˆ)</option>
                                <option value="gemini-pro">Gemini Pro (ê¸°ë³¸)</option>
                            </select>
                        </div>

                        <!-- Minimax API Key -->
                        <div class="bg-green-50 rounded-xl p-6 border-2 border-green-200">
                            <label class="flex items-center gap-2 text-lg font-bold text-gray-800 mb-3">
                                <i class="fas fa-microphone text-green-600 text-2xl"></i>
                                Minimax API Key
                                <span class="text-sm font-normal text-gray-500">(ìŒì„± ìƒì„±ìš©)</span>
                            </label>
                            <div class="relative mb-2">
                                <input type="password" id="minimaxApiKey" name="minimaxApiKey"
                                    class="w-full px-4 py-3 border-2 border-green-300 rounded-lg focus:ring-4 focus:ring-green-200 focus:border-green-500 text-lg"
                                    placeholder="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...">
                                <button type="button" onclick="togglePassword('minimaxApiKey')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-600">
                                <a href="https://www.minimaxi.com/" target="_blank" class="text-green-600 hover:underline font-semibold">
                                    <i class="fas fa-external-link-alt mr-1"></i>Minimax ì½˜ì†”ì—ì„œ ë°œê¸‰ë°›ê¸°
                                </a>
                            </p>
                        </div>

                        <!-- Minimax Group ID -->
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-users text-green-600"></i>
                                Minimax Group ID
                            </label>
                            <input type="text" id="minimaxGroupId" name="minimaxGroupId"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                placeholder="1234567890">
                        </div>

                        <!-- Shotstack API Key -->
                        <div class="bg-red-50 rounded-xl p-6 border-2 border-red-200">
                            <label class="flex items-center gap-2 text-lg font-bold text-gray-800 mb-3">
                                <i class="fas fa-film text-red-600 text-2xl"></i>
                                Shotstack API Key
                                <span class="text-sm font-normal text-gray-500">(ë¹„ë””ì˜¤ í¸ì§‘ìš©)</span>
                            </label>
                            <div class="relative mb-2">
                                <input type="password" id="shotstackApiKey" name="shotstackApiKey"
                                    class="w-full px-4 py-3 border-2 border-red-300 rounded-lg focus:ring-4 focus:ring-red-200 focus:border-red-500 text-lg"
                                    placeholder="ctDGYT...">
                                <button type="button" onclick="togglePassword('shotstackApiKey')"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-600">
                                <a href="https://dashboard.shotstack.io/register" target="_blank" class="text-red-600 hover:underline font-semibold">
                                    <i class="fas fa-external-link-alt mr-1"></i>Shotstack ëŒ€ì‹œë³´ë“œì—ì„œ ë°œê¸‰ë°›ê¸°
                                </a>
                            </p>
                        </div>

                        <hr class="my-8 border-gray-300">

                        <!-- ê¸°ë³¸ ì„¤ì • ì„¹ì…˜ -->
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-palette text-purple-600 text-2xl"></i>
                                ê¸°ë³¸ ì„¤ì •
                            </h3>
                            <p class="text-sm text-gray-600 mt-2">ì˜ìƒ ìƒì„±ì— ì‚¬ìš©í•  ë°°ê²½ìŒì•…ê³¼ ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                        </div>

                        <!-- ë°°ê²½ìŒì•… ê´€ë¦¬ -->
                        <div class="bg-purple-50 rounded-xl p-6 border-2 border-purple-200">
                            <label class="block text-lg font-bold text-gray-800 mb-4 flex items-center justify-between">
                                <span><i class="fas fa-music text-purple-600 mr-2"></i>ë°°ê²½ìŒì•… ê´€ë¦¬</span>
                                <button type="button" onclick="document.getElementById('bgmFile').click()" 
                                    class="px-4 py-2 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-2 shadow-md">
                                    <i class="fas fa-plus"></i> ìŒì•… ì¶”ê°€
                                </button>
                            </label>
                            <input type="file" id="bgmFile" accept="audio/*,.mp3,.wav,.m4a,.ogg" 
                                class="hidden" onchange="handleBgmUpload(event)">
                            
                            <div id="bgmList" class="space-y-3 max-h-80 overflow-y-auto">
                                <div class="p-6 bg-white rounded-lg text-center text-gray-500">
                                    <i class="fas fa-music text-4xl mb-3 text-purple-300"></i>
                                    <p class="font-semibold">ë“±ë¡ëœ ë°°ê²½ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤</p>
                                    <p class="text-xs mt-2">ìœ„ì˜ "ìŒì•… ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°°ê²½ìŒì•…ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (ìµœëŒ€ 1.5MB)</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mt-3">
                                <i class="fas fa-info-circle mr-1"></i>
                                ì—…ë¡œë“œí•œ ë°°ê²½ìŒì•…ì€ ë©”ì¸ í˜ì´ì§€ì—ì„œ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>

                        <!-- ë°°ê²½ ì´ë¯¸ì§€ ê´€ë¦¬ -->
                        <div class="bg-blue-50 rounded-xl p-6 border-2 border-blue-200 mt-6">
                            <label class="block text-lg font-bold text-gray-800 mb-4 flex items-center justify-between">
                                <span><i class="fas fa-image text-blue-600 mr-2"></i>ë°°ê²½ ì´ë¯¸ì§€ ê´€ë¦¬</span>
                                <button type="button" onclick="document.getElementById('bgImageFile').click()" 
                                    class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2 shadow-md">
                                    <i class="fas fa-plus"></i> ì´ë¯¸ì§€ ì¶”ê°€
                                </button>
                            </label>
                            <input type="file" id="bgImageFile" accept="image/*,.jpg,.jpeg,.png,.gif,.webp" 
                                class="hidden" onchange="handleBgImageUpload(event)">
                            
                            <div id="bgImageList" class="grid grid-cols-2 gap-3 max-h-80 overflow-y-auto">
                                <div class="col-span-2 p-6 bg-white rounded-lg text-center text-gray-500">
                                    <i class="fas fa-image text-4xl mb-3 text-blue-300"></i>
                                    <p class="font-semibold">ë“±ë¡ëœ ë°°ê²½ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                    <p class="text-xs mt-2">ìœ„ì˜ "ì´ë¯¸ì§€ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (ìµœëŒ€ 2MB)</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mt-3">
                                <i class="fas fa-info-circle mr-1"></i>
                                ì—…ë¡œë“œí•œ ë°°ê²½ ì´ë¯¸ì§€ëŠ” ë©”ì¸ í˜ì´ì§€ì—ì„œ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>

                        <!-- ì €ì¥ ë²„íŠ¼ -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-6 mt-8 border-t-2 border-gray-200">
                            <button type="submit" 
                                class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition shadow-xl">
                                <i class="fas fa-save mr-2"></i>API í‚¤ ì €ì¥
                            </button>
                            <button type="button" onclick="testApiKeys()"
                                class="bg-green-600 text-white py-4 px-6 rounded-lg font-bold text-lg hover:bg-green-700 transition shadow-xl">
                                <i class="fas fa-check-circle mr-2"></i>API í‚¤ í…ŒìŠ¤íŠ¸
                            </button>
                            <button type="button" onclick="cleanupInvalidMedia()"
                                class="bg-red-600 text-white py-4 px-6 rounded-lg font-bold text-lg hover:bg-red-700 transition shadow-xl">
                                <i class="fas fa-trash-alt mr-2"></i>ì†ìƒ íŒŒì¼ ì •ë¦¬
                            </button>
                        </div>
                    </form>

                    <!-- ì €ì¥ ì„±ê³µ ë©”ì‹œì§€ -->
                    <div id="successMessage" class="hidden mt-6 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                        <div class="flex items-center gap-3 text-green-800">
                            <i class="fas fa-check-circle text-2xl"></i>
                            <span class="font-bold text-lg">API í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
                        </div>
                    </div>

                    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                    <div id="errorMessage" class="hidden mt-6 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                        <div class="flex items-center gap-3 text-red-800">
                            <i class="fas fa-exclamation-circle text-2xl"></i>
                            <span class="font-bold text-lg" id="errorText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = '';
        let currentUser = null;

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ğŸš€ğŸš€ ë§ˆì´í˜ì´ì§€ ì‹œì‘ ğŸš€ğŸš€ğŸš€');
            await checkAuth();
            await loadUserSettings();
            await loadBackgroundSettings();
            
            // êµ¬ë… ì •ë³´ì™€ ê²°ì œ ë‚´ì—­ì„ ëª…ì‹œì ìœ¼ë¡œ ë¡œë“œ
            console.log('ğŸ’³ ê²°ì œ ë‚´ì—­ ë¡œë“œ ì‹œì‘...');
            await loadPaymentHistory();
            
            console.log('ğŸ‘‘ êµ¬ë… ì •ë³´ ë¡œë“œ ì‹œì‘...');
            await loadSubscriptionInfo();
            
            console.log('âœ… ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        });

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            console.log('ğŸ”„ íƒ­ ì „í™˜:', tabName);
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ì„ íƒí•œ íƒ­ í™œì„±í™”
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('content-' + tabName).classList.remove('hidden');
        }

        // ì¸ì¦ í™•ì¸
        async function checkAuth() {
            console.log('ğŸ” ì¸ì¦ í™•ì¸...');
            const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
            if (!authToken) {
                console.log('âŒ í† í° ì—†ìŒ');
                window.location.href = '/login.html';
                return;
            }

            try {
                // Get user info from localStorage (saved during login)
                const userInfoStr = localStorage.getItem('user_info');
                
                if (!userInfoStr) {
                    throw new Error('ì‚¬ìš©ì ì •ë³´ ì—†ìŒ');
                }
                
                const user = JSON.parse(userInfoStr);
                console.log('âœ… ì‚¬ìš©ì ë°ì´í„°:', user);
                
                currentUser = user;
                displayUserInfo(currentUser);
                await loadUserStats();
                
            } catch (error) {
                console.error('âŒ ì¸ì¦ ì—ëŸ¬:', error);
                localStorage.removeItem('jwt_token'); 
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_info');
                window.location.href = '/login.html';
            }
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        function displayUserInfo(user) {
            console.log('ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ');
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').src = user.picture || 'https://via.placeholder.com/40';

            const roleBadge = document.getElementById('userRoleBadge');
            const roleMap = {
                'super_admin': { text: 'ìµœê³  ê´€ë¦¬ì', color: 'bg-red-500 text-white' },
                'admin': { text: 'ê´€ë¦¬ì', color: 'bg-purple-500 text-white' },
                'user': { text: 'ì¼ë°˜ ì‚¬ìš©ì', color: 'bg-blue-500 text-white' }
            };
            const roleInfo = roleMap[user.role] || roleMap['user'];
            roleBadge.textContent = roleInfo.text;
            roleBadge.className = `inline-block px-4 py-2 text-sm font-bold rounded-full ${roleInfo.color}`;

            const joinDate = new Date(user.created_at);
            const daysSince = Math.floor((Date.now() - joinDate.getTime()) / (1000 * 60 * 60 * 24));
            document.getElementById('memberSince').textContent = `${daysSince}ì¼`;
        }

        // ì‚¬ìš©ì í†µê³„
        async function loadUserStats() {
            console.log('ğŸ“Š í†µê³„ ë¡œë“œ');
            const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
            try {
                const response = await fetch(`${API_BASE}/api/users/me/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('totalVideos').textContent = data.data.total_video_requests || 0;
                        document.getElementById('totalProjects').textContent = data.data.total_projects || 0;
                    }
                }
            } catch (error) {
                console.error('âŒ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê²°ì œ ë‚´ì—­ ë¡œë“œ
        async function loadPaymentHistory() {
            console.log('ğŸ’³ğŸ’³ğŸ’³ ê²°ì œ ë‚´ì—­ ë¡œë“œ í•¨ìˆ˜ ì‹œì‘');
            const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
            if (!authToken) {
                console.log('âŒ í† í° ì—†ìŒ');
                return;
            }

            const loadingEl = document.getElementById('paymentHistoryLoading');
            const emptyEl = document.getElementById('paymentHistoryEmpty');
            const listEl = document.getElementById('paymentHistoryList');

            try {
                console.log('ğŸ“¡ API í˜¸ì¶œ: /api/user/payments');
                const response = await fetch(`${API_BASE}/api/user/payments`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', response.status);
                const data = await response.json();
                console.log('ğŸ“¦ ì‘ë‹µ ë°ì´í„°:', JSON.stringify(data, null, 2));
                
                loadingEl.classList.add('hidden');
                
                if (data.success && data.data && data.data.length > 0) {
                    console.log(`âœ…âœ…âœ… ${data.data.length}ê°œì˜ ê²°ì œ ë‚´ì—­ ë°œê²¬!`);
                    emptyEl.classList.add('hidden');
                    displayPaymentHistory(data.data);
                } else {
                    console.log('â„¹ï¸ ê²°ì œ ë‚´ì—­ ì—†ìŒ');
                    emptyEl.classList.remove('hidden');
                    listEl.classList.add('hidden');
                }
            } catch (error) {
                console.error('âŒâŒâŒ ê²°ì œ ë‚´ì—­ ë¡œë“œ ì—ëŸ¬:', error);
                loadingEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
            }
        }

        // ê²°ì œ ë‚´ì—­ í‘œì‹œ
        function displayPaymentHistory(payments) {
            console.log('ğŸ¨ ê²°ì œ ë‚´ì—­ í‘œì‹œ:', payments.length);
            const listEl = document.getElementById('paymentHistoryList');
            listEl.classList.remove('hidden');
            
            const statusColors = {
                'pending': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'confirmed': 'bg-green-100 text-green-800 border-green-300',
                'failed': 'bg-red-100 text-red-800 border-red-300',
                'rejected': 'bg-red-100 text-red-800 border-red-300'
            };
            
            const statusTexts = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'confirmed': 'ì™„ë£Œ',
                'failed': 'ì‹¤íŒ¨',
                'rejected': 'ê±°ë¶€ë¨'
            };
            
            const methodTexts = {
                'bank_transfer': 'ë¬´í†µì¥ ì…ê¸ˆ',
                'payapp': 'ê°„í¸ê²°ì œ'
            };
            
            const planTexts = {
                'test': 'í…ŒìŠ¤íŠ¸ í”Œëœ (1ì¼)',
                'monthly': 'ì›”ê°„ í”Œëœ (30ì¼)',
                'yearly': 'ì—°ê°„ í”Œëœ (365ì¼)'
            };
            
            listEl.innerHTML = payments.map(payment => {
                const date = new Date(payment.created_at);
                const dateStr = date.toLocaleDateString('ko-KR');
                const timeStr = date.toLocaleTimeString('ko-KR');
                
                return `
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-6 hover:shadow-xl transition">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h4 class="text-2xl font-bold text-gray-800 mb-2">${payment.amount.toLocaleString()}ì›</h4>
                                <p class="text-gray-600 mb-1">
                                    <i class="fas fa-credit-card mr-2"></i>${methodTexts[payment.payment_method] || payment.payment_method}
                                </p>
                                ${payment.plan_name ? `
                                    <p class="text-purple-600 font-semibold">
                                        <i class="fas fa-crown mr-2"></i>${planTexts[payment.plan_name] || payment.plan_name}
                                    </p>
                                ` : ''}
                            </div>
                            <span class="px-4 py-2 rounded-full text-sm font-bold border-2 ${statusColors[payment.status]}">
                                ${statusTexts[payment.status]}
                            </span>
                        </div>
                        <div class="text-sm text-gray-500 flex items-center gap-4">
                            <span><i class="fas fa-calendar mr-2"></i>${dateStr}</span>
                            <span><i class="fas fa-clock mr-2"></i>${timeStr}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // êµ¬ë… ì •ë³´ ë¡œë“œ
        async function loadSubscriptionInfo() {
            console.log('ğŸ‘‘ğŸ‘‘ğŸ‘‘ êµ¬ë… ì •ë³´ ë¡œë“œ í•¨ìˆ˜ ì‹œì‘');
            const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
            if (!authToken) {
                console.log('âŒ í† í° ì—†ìŒ');
                return;
            }

            const loadingEl = document.getElementById('subscriptionLoading');
            const emptyEl = document.getElementById('subscriptionEmpty');
            const infoEl = document.getElementById('subscriptionInfo');

            try {
                console.log('ğŸ“¡ API í˜¸ì¶œ: /api/user/subscription');
                const response = await fetch(`${API_BASE}/api/user/subscription`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', response.status);
                const data = await response.json();
                console.log('ğŸ“¦ ì‘ë‹µ ë°ì´í„°:', JSON.stringify(data, null, 2));
                
                loadingEl.classList.add('hidden');
                
                if (data.success && data.data) {
                    console.log('âœ…âœ…âœ… í™œì„± êµ¬ë… ë°œê²¬:', data.data.plan_name);
                    emptyEl.classList.add('hidden');
                    displaySubscriptionInfo(data.data);
                } else {
                    console.log('â„¹ï¸ í™œì„± êµ¬ë… ì—†ìŒ');
                    emptyEl.classList.remove('hidden');
                    infoEl.classList.add('hidden');
                }
            } catch (error) {
                console.error('âŒâŒâŒ êµ¬ë… ì •ë³´ ë¡œë“œ ì—ëŸ¬:', error);
                loadingEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
            }
        }

        // êµ¬ë… ì •ë³´ í‘œì‹œ
        function displaySubscriptionInfo(subscription) {
            console.log('ğŸ¨ êµ¬ë… ì •ë³´ í‘œì‹œ');
            const infoEl = document.getElementById('subscriptionInfo');
            infoEl.classList.remove('hidden');
            
            const startDate = new Date(subscription.start_date);
            const endDate = new Date(subscription.end_date);
            const now = new Date();
            const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            
            const planTexts = {
                'test': 'í…ŒìŠ¤íŠ¸ í”Œëœ',
                'monthly': 'ì›”ê°„ í”Œëœ',
                'yearly': 'ì—°ê°„ í”Œëœ'
            };
            
            infoEl.innerHTML = `
                <div class="bg-gradient-to-br from-purple-100 to-pink-100 border-4 border-purple-400 rounded-2xl p-8 shadow-2xl">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="bg-green-500 rounded-full p-4">
                            <i class="fas fa-check-circle text-5xl text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-3xl font-bold text-gray-800">${planTexts[subscription.plan_name] || subscription.plan_name}</h3>
                            <p class="text-xl text-purple-700 font-semibold">í™œì„± êµ¬ë… ì¤‘</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <p class="text-gray-600 text-sm mb-1">ê²°ì œ ê¸ˆì•¡</p>
                            <p class="font-bold text-2xl text-gray-800">${subscription.price.toLocaleString()}ì›</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <p class="text-gray-600 text-sm mb-1">ë‚¨ì€ ê¸°ê°„</p>
                            <p class="font-bold text-2xl ${daysLeft <= 7 ? 'text-red-600' : 'text-green-600'}">${daysLeft}ì¼</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <p class="text-gray-600 text-sm mb-1">ì‹œì‘ì¼</p>
                            <p class="font-semibold text-lg text-gray-800">${startDate.toLocaleDateString('ko-KR')}</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <p class="text-gray-600 text-sm mb-1">ë§Œë£Œì¼</p>
                            <p class="font-semibold text-lg text-gray-800">${endDate.toLocaleDateString('ko-KR')}</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <a href="/payment" class="inline-block px-8 py-3 bg-gradient-to-r from-yellow-500 to-orange-600 text-white rounded-lg hover:from-yellow-600 hover:to-orange-700 transition font-bold text-lg shadow-xl">
                            <i class="fas fa-crown mr-2"></i>í”Œëœ ë³€ê²½í•˜ê¸°
                        </a>
                    </div>
                </div>
            `;
        }

        // ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
        async function loadUserSettings() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/settings/${currentUser.id}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        const settings = data.data;
                        document.getElementById('geminiApiKey').value = settings.gemini_api_key || '';
                        document.getElementById('geminiModel').value = settings.gemini_model || 'gemini-2.0-flash-exp';
                        document.getElementById('minimaxApiKey').value = settings.minimax_api_key || '';
                        document.getElementById('minimaxGroupId').value = settings.minimax_group_id || '';
                        document.getElementById('shotstackApiKey').value = settings.shotstack_api_key || '';
                    }
                }
            } catch (error) {
                console.error('Settings load error:', error);
            }
        }

        // API í‚¤ ì €ì¥
        document.getElementById('apiKeyForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                userId: currentUser.id,
                geminiApiKey: document.getElementById('geminiApiKey').value.trim(),
                geminiModel: document.getElementById('geminiModel').value,
                minimaxApiKey: document.getElementById('minimaxApiKey').value.trim(),
                minimaxGroupId: document.getElementById('minimaxGroupId').value.trim(),
                shotstackApiKey: document.getElementById('shotstackApiKey').value.trim()
            };

            try {
                const response = await fetch(`${API_BASE}/api/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccessMessage();
                } else {
                    showErrorMessage(data.error || 'ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Save error:', error);
                showErrorMessage('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ í† ê¸€
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.nextElementSibling.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // API í‚¤ í…ŒìŠ¤íŠ¸
        async function testApiKeys() {
            alert('API í‚¤ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ì„±ê³µ ë©”ì‹œì§€
        function showSuccessMessage() {
            document.getElementById('successMessage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('hidden');
            }, 3000);
        }

        // ì—ëŸ¬ ë©”ì‹œì§€
        function showErrorMessage(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            localStorage.removeItem('jwt_token'); localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
        }

        // ë°°ê²½ ì„¤ì • ë¡œë“œ
        async function loadBackgroundSettings() {
            if (!currentUser) return;
            
            console.log('ğŸµ ë°°ê²½ ì„¤ì • ë¡œë“œ ì‹œì‘');
            const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
            
            try {
                // ë°°ê²½ìŒì•… ë¡œë“œ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì‚¬ìš©)
                const bgmResponse = await fetch(`${API_BASE}/api/background-music?userId=${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (bgmResponse.ok) {
                    const bgmData = await bgmResponse.json();
                    console.log('âœ… ë°°ê²½ìŒì•… ë°ì´í„°:', bgmData);
                    if (bgmData.success && bgmData.data) {
                        displayBgmList(bgmData.data);
                    }
                } else {
                    console.error('âŒ ë°°ê²½ìŒì•… ë¡œë“œ ì‹¤íŒ¨:', bgmResponse.status);
                }
                
                // ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì‚¬ìš©)
                const bgImageResponse = await fetch(`${API_BASE}/api/background-images?userId=${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (bgImageResponse.ok) {
                    const bgImageData = await bgImageResponse.json();
                    console.log('âœ… ë°°ê²½ ì´ë¯¸ì§€ ë°ì´í„°:', bgImageData);
                    if (bgImageData.success && bgImageData.data) {
                        displayBgImageList(bgImageData.data);
                    }
                } else {
                    console.error('âŒ ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', bgImageResponse.status);
                }
            } catch (error) {
                console.error('âŒ ë°°ê²½ ì„¤ì • ë¡œë“œ ì—ëŸ¬:', error);
            }
        }

        // ë°°ê²½ìŒì•… ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        function displayBgmList(bgms) {
            const listEl = document.getElementById('bgmList');
            
            // ì‚­ì œëœ í•­ëª© í•„í„°ë§
            const deletedBgms = JSON.parse(sessionStorage.getItem('deletedBgms') || '[]');
            const filteredBgms = bgms.filter(bgm => !deletedBgms.includes(bgm.id));
            
            if (!filteredBgms || filteredBgms.length === 0) {
                listEl.innerHTML = `
                    <div class="p-6 bg-white rounded-lg text-center text-gray-500">
                        <i class="fas fa-music text-4xl mb-3 text-purple-300"></i>
                        <p class="font-semibold">ë“±ë¡ëœ ë°°ê²½ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-xs mt-2">ìœ„ì˜ "ìŒì•… ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°°ê²½ìŒì•…ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = filteredBgms.map(bgm => `
                <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-purple-200 hover:shadow-md transition">
                    <div class="flex items-center gap-3 flex-1">
                        <i class="fas fa-music text-2xl text-purple-600"></i>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${bgm.name}</p>
                            <p class="text-xs text-gray-500">
                                ${new Date(bgm.created_at).toLocaleDateString('ko-KR')}
                            </p>
                        </div>
                    </div>
                    <button type="button" onclick="deleteBgm('${bgm.id}')" 
                        class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // ë°°ê²½ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        function displayBgImageList(images) {
            const listEl = document.getElementById('bgImageList');
            
            // ì‚­ì œëœ í•­ëª© í•„í„°ë§
            const deletedImages = JSON.parse(sessionStorage.getItem('deletedBgImages') || '[]');
            const filteredImages = images.filter(img => !deletedImages.includes(img.id));
            
            if (!filteredImages || filteredImages.length === 0) {
                listEl.innerHTML = `
                    <div class="col-span-2 p-6 bg-white rounded-lg text-center text-gray-500">
                        <i class="fas fa-image text-4xl mb-3 text-blue-300"></i>
                        <p class="font-semibold">ë“±ë¡ëœ ë°°ê²½ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-xs mt-2">ìœ„ì˜ "ì´ë¯¸ì§€ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = filteredImages.map(img => `
                <div class="relative group">
                    <img src="${img.data_url}" alt="${img.name}" 
                        class="w-full h-32 object-cover rounded-lg border-2 border-blue-200">
                    <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center rounded-lg">
                        <button type="button" onclick="deleteBgImage('${img.id}')" 
                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                            <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mt-1 truncate">${img.name}</p>
                </div>
            `).join('');
        }

        // ë°°ê²½ìŒì•… ì—…ë¡œë“œ
        async function handleBgmUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('audio/')) {
                alert('ì˜¤ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                event.target.value = '';
                return;
            }

            if (file.size > 1.5 * 1024 * 1024) {
                alert('ë°°ê²½ìŒì•… íŒŒì¼ì€ ìµœëŒ€ 1.5MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                event.target.value = '';
                return;
            }

            console.log('ğŸ“¤ ë°°ê²½ìŒì•… ì—…ë¡œë“œ:', file.name);

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const dataUrl = e.target.result;
                    const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
                    
                    const response = await fetch(`${API_BASE}/api/background-music/upload`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            name: file.name,
                            dataUrl: dataUrl,
                            duration: 0,
                            userId: currentUser.id
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        console.log('âœ… ë°°ê²½ìŒì•… ì—…ë¡œë“œ ì„±ê³µ');
                        await loadBackgroundSettings();
                        event.target.value = '';
                        alert('âœ… ë°°ê²½ìŒì•…ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        throw new Error(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    console.error('âŒ ë°°ê²½ìŒì•… ì—…ë¡œë“œ ì—ëŸ¬:', error);
                    alert('âŒ ë°°ê²½ìŒì•… ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    event.target.value = '';
                }
            };
            
            reader.onerror = function() {
                alert('âŒ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                event.target.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        // ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function handleBgImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                event.target.value = '';
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('ë°°ê²½ ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 2MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                event.target.value = '';
                return;
            }

            console.log('ğŸ“¤ ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ:', file.name);

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const dataUrl = e.target.result;
                    const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
                    
                    const response = await fetch(`${API_BASE}/api/background-images/upload`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            name: file.name,
                            dataUrl: dataUrl,
                            userId: currentUser.id
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        console.log('âœ… ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ');
                        await loadBackgroundSettings();
                        event.target.value = '';
                        alert('âœ… ë°°ê²½ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        throw new Error(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    console.error('âŒ ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì—ëŸ¬:', error);
                    alert('âŒ ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    event.target.value = '';
                }
            };
            
            reader.onerror = function() {
                alert('âŒ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                event.target.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        // ë°°ê²½ìŒì•… ì‚­ì œ
        async function deleteBgm(id) {
            if (!confirm('ì´ ë°°ê²½ìŒì•…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE}/api/background-music/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (data.success) {
                    console.log('âœ… ë°°ê²½ìŒì•… ì‚­ì œ ì„±ê³µ');
                    
                    // ì‚­ì œëœ IDë¥¼ sessionStorageì— ì €ì¥
                    const deletedBgms = JSON.parse(sessionStorage.getItem('deletedBgms') || '[]');
                    deletedBgms.push(id);
                    sessionStorage.setItem('deletedBgms', JSON.stringify(deletedBgms));
                    
                    await loadBackgroundSettings();
                    alert('âœ… ë°°ê²½ìŒì•…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    throw new Error(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ ë°°ê²½ìŒì•… ì‚­ì œ ì—ëŸ¬:', error);
                alert('âŒ ë°°ê²½ìŒì•… ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë°°ê²½ ì´ë¯¸ì§€ ì‚­ì œ
        async function deleteBgImage(id) {
            if (!confirm('ì´ ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE}/api/background-images/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (data.success) {
                    console.log('âœ… ë°°ê²½ ì´ë¯¸ì§€ ì‚­ì œ ì„±ê³µ');
                    
                    // ì‚­ì œëœ IDë¥¼ sessionStorageì— ì €ì¥
                    const deletedImages = JSON.parse(sessionStorage.getItem('deletedBgImages') || '[]');
                    deletedImages.push(id);
                    sessionStorage.setItem('deletedBgImages', JSON.stringify(deletedImages));
                    
                    await loadBackgroundSettings();
                    alert('âœ… ë°°ê²½ ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    throw new Error(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ ë°°ê²½ ì´ë¯¸ì§€ ì‚­ì œ ì—ëŸ¬:', error);
                alert('âŒ ë°°ê²½ ì´ë¯¸ì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì†ìƒëœ ë¯¸ë””ì–´ íŒŒì¼ ì •ë¦¬
        async function cleanupInvalidMedia() {
            if (!confirm('ëª¨ë“  ë°°ê²½ìŒì•…ê³¼ ì´ë¯¸ì§€ íŒŒì¼ì„ í™•ì¸í•˜ê³  ì†ìƒëœ íŒŒì¼ì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìœ íš¨í•˜ì§€ ì•Šì€ dataUrlì„ ê°€ì§„ íŒŒì¼ì´ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                const authToken = localStorage.getItem('jwt_token') || localStorage.getItem('auth_token');
                let deletedCount = 0;
                
                // ë°°ê²½ìŒì•… í™•ì¸ ë° ì •ë¦¬
                const bgmResponse = await fetch(`${API_BASE}/api/background-music?userId=${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (bgmResponse.ok) {
                    const bgmData = await bgmResponse.json();
                    if (bgmData.success && bgmData.data) {
                        for (const bgm of bgmData.data) {
                            // dataUrlì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì‚­ì œ
                            if (!bgm.dataUrl || !bgm.dataUrl.startsWith('data:audio/')) {
                                try {
                                    const delResponse = await fetch(`${API_BASE}/api/background-music/${bgm.id}`, {
                                        method: 'DELETE',
                                        headers: { 'Authorization': `Bearer ${authToken}` }
                                    });
                                    if (delResponse.ok) deletedCount++;
                                } catch (err) {
                                    console.error('ë°°ê²½ìŒì•… ì‚­ì œ ì‹¤íŒ¨:', bgm.id);
                                }
                            }
                        }
                    }
                }
                
                // ë°°ê²½ ì´ë¯¸ì§€ í™•ì¸ ë° ì •ë¦¬
                const imgResponse = await fetch(`${API_BASE}/api/background-images?userId=${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (imgResponse.ok) {
                    const imgData = await imgResponse.json();
                    if (imgData.success && imgData.data) {
                        for (const img of imgData.data) {
                            // dataUrlì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì‚­ì œ
                            if (!img.dataUrl || !img.dataUrl.startsWith('data:image/')) {
                                try {
                                    const delResponse = await fetch(`${API_BASE}/api/background-images/${img.id}`, {
                                        method: 'DELETE',
                                        headers: { 'Authorization': `Bearer ${authToken}` }
                                    });
                                    if (delResponse.ok) deletedCount++;
                                } catch (err) {
                                    console.error('ë°°ê²½ ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨:', img.id);
                                }
                            }
                        }
                    }
                }
                
                await loadBackgroundSettings();
                
                if (deletedCount > 0) {
                    alert(`âœ… ì •ë¦¬ ì™„ë£Œ!\n\nì‚­ì œëœ ì†ìƒ íŒŒì¼: ${deletedCount}ê°œ`);
                } else {
                    alert('â„¹ï¸ ëª¨ë“  íŒŒì¼ì´ ì •ìƒì…ë‹ˆë‹¤. ì†ìƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ íŒŒì¼ ì •ë¦¬ ì—ëŸ¬:', error);
                alert('âŒ íŒŒì¼ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
            }
        }
    </script>
</body>
</html>
